#
# (C) Copyright IBM Corp. 2020, 2021
#
# SPDX-License-Identifier: Apache-2.0
#
#Observation resource
---

resourceType: Observation
id:
  type: STRING
  valueOf: 'UUID.randomUUID()'
  expressionType: JEXL
identifier:
  valueOf: datatype/Identifier_Observation
  generateList: true
  expressionType: resource
  vars:
    obx3: BUILD_IDENTIFIER_FROM_CWE, OBX.5
    fillpla: STRING, ORC.3.1 | OBR.3.1 | ORC.2.1 | OBR.2.1 | MSH.7
  constants:
    sys: "urn:id:extID"
    joinChar: '-'
status:
   type: OBSERVATION_STATUS
   default: unknown
   expressionType: HL7Spec

# When OBX's are missing or TX based, we don't want to create an Observation.
# When TX, because content is already appended to an associated DiagnosticReport or DocumentReference
# Logic: if OBX exists AND ( (OBX.2 exists AND OBX.2 is NOT TX) OR (OBX.2 is null/empty) ) AND OBX.3 NOT NULL CREATE the Observation.
# 'code' is set 'required: true' to cause all or nothing creation logic
# The expression is nested and values are passed to the nested so that BOTH values control the 'all or nothing'
code:
   valueOf: datatype/CodeableConcept
   expressionType: resource
   required: true
   specs: OBX.5

subject:
    valueOf: datatype/Reference
    expressionType: resource
    specs: $Patient

encounter:
    valueOf: datatype/Reference
    expressionType: resource
    specs: $Encounter

